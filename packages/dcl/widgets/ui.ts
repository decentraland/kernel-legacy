import { SharedSceneContext } from 'engine/entities/SharedSceneContext'
import { WebGLScene } from 'dcl/WebGLScene'
import { SceneWorker } from 'shared/world/SceneWorker'
import { ChatController } from 'dcl/api/ChatController'
import { SocialController } from 'shared/apis/SocialController'
import { createLogger } from 'shared/logger'

const chatWorkerRaw = require('raw-loader!../../../static/systems/chat.scene.js')
const chatWorkerBLOB = new Blob([chatWorkerRaw])
const chatWorkerUrl = URL.createObjectURL(chatWorkerBLOB)

const hudWorkerRaw = require('raw-loader!../../../static/systems/avatarProfile.scene.js')
const hudWorkerBLOB = new Blob([hudWorkerRaw])
const hudWorkerUrl = URL.createObjectURL(hudWorkerBLOB)

export class WebGLUIScene extends WebGLScene<any> {
  constructor(id: string, main: string, context: SharedSceneContext) {
    super(
      {
        baseUrl: context.baseUrl,
        name: context.name,
        main,
        data: {},
        id,
        mappings: []
      },
      context
    )

    this.context.rootEntity.name = this.context.rootEntity.id = id
    // tslint:disable-next-line:no-unused-expression
    new SceneWorker(this)
  }
}

export async function initHudSystem(): Promise<WebGLUIScene> {
  const context = new SharedSceneContext('/', 'ui-context-hud', false)
  context.logger = createLogger('hud-scene: ')
  const scene = new WebGLUIScene('hud', hudWorkerUrl, context)
  const system = await scene.worker.system

  // Create instances of non-public-controllers
  system.getAPIInstance(ChatController)
  system.getAPIInstance(SocialController)

  return scene
}

export async function initChatSystem(): Promise<WebGLUIScene> {
  const context = new SharedSceneContext('/', 'ui-context-chat', false)
  context.logger = createLogger('chat-scene: ')
  const scene = new WebGLUIScene('chat', chatWorkerUrl, context)
  const system = await scene.worker.system

  // Create instance of non-public-controllers
  system.getAPIInstance(ChatController)

  return scene
}
